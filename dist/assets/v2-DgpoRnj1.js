import"./modulepreload-polyfill-B5Qt9EMX.js";const $=void 0,B=void 0,S="EXAVITQu4vr4xnSDxMaL",I="eleven_multilingual_v2",T=document.getElementById("stage"),k=document.getElementById("status"),f=document.getElementById("startBtn"),b=document.getElementById("stopBtn"),o=document.getElementById("player"),E=document.getElementById("lang");let z=!1,O="Bezczynny";function l(e){O=e,T.textContent=e}function s(e,a=!1){const t=a?"❌ ":"• ";k.innerText=`${k.innerText}
${t}${e}`.trim(),a&&k.classList.add("error")}function j(e){k.classList.remove("error"),k.innerText=e}function x(e){return new Promise(a=>setTimeout(a,e))}function N(){return(E==null?void 0:E.value)==="en"?"en":"pl"}function L(){const e=[];if(e.push("VITE_OPENAI_API_KEY"),e.push("VITE_ELEVENLABS_API_KEY"),e.length){const a=`Brak zmiennych środowiskowych: ${e.join(", ")}. Upewnij się, że sekrety repozytorium są ustawione i przekazywane do kompilacji.`;throw new Error(a)}}async function U(){return l("Pobieranie lokalizacji"),new Promise((e,a)=>{if(!("geolocation"in navigator)){a(new Error("Geolokalizacja nie jest obsługiwana przez tę przeglądarkę."));return}navigator.geolocation.getCurrentPosition(t=>{e({lat:t.coords.latitude,lon:t.coords.longitude})},t=>{const n=`code=${t.code}, message=${t.message}`;a(new Error(`Nie udało się pobrać lokalizacji. Szczegóły: ${n}`))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})})}async function R(e,a){var P,A,v;l("Wyszukiwanie atrakcji");const t=a==="en"?"https://en.wikipedia.org":"https://pl.wikipedia.org",n=new URL(t+"/w/api.php");n.searchParams.set("format","json"),n.searchParams.set("origin","*"),n.searchParams.set("action","query"),n.searchParams.set("list","geosearch"),n.searchParams.set("gscoord",`${e.lat}|${e.lon}`),n.searchParams.set("gsradius","1500"),n.searchParams.set("gslimit","10");const i=await fetch(n.toString(),{mode:"cors"});if(!i.ok)throw new Error(`Błąd zapytania geosearch Wikipedia: HTTP ${i.status}`);const c=await i.json(),u=(P=c==null?void 0:c.query)==null?void 0:P.geosearch;if(!u||u.length===0)throw new Error("Nie znaleziono żadnych atrakcji w pobliżu (Wikipedia geosearch).");const p=u[0],d=p.pageid,m=p.title,w=p.dist,r=new URL(t+"/w/api.php");r.searchParams.set("format","json"),r.searchParams.set("origin","*"),r.searchParams.set("action","query"),r.searchParams.set("prop","extracts"),r.searchParams.set("exintro",""),r.searchParams.set("explaintext",""),r.searchParams.set("redirects","1"),r.searchParams.set("pageids",String(d));const y=await fetch(r.toString(),{mode:"cors"});if(!y.ok)throw new Error(`Błąd pobierania opisu z Wikipedii: HTTP ${y.status}`);const h=await y.json(),g=(v=(A=h==null?void 0:h.query)==null?void 0:A.pages)==null?void 0:v[d],_=(g==null?void 0:g.extract)??"";return{pageId:d,title:m,extract:_,distanceMeters:w??NaN}}async function M(e,a){var r,y,h;l("Generowanie skryptu"),L();const t=a==="pl",n=t?"Jesteś lokalnym przewodnikiem turystycznym. Tworzysz zwięzłe, przyjazne i naturalne opisy atrakcji w języku polskim.":"You are a local tour guide. You create concise, friendly and natural descriptions of attractions in English.",i=isFinite(e.distanceMeters)?Math.round(e.distanceMeters)+" m":t?"nieznana":"unknown",c=e.extract||(t?"brak":"none"),u=t?`
Atrakcja: ${e.title}
Odległość: ${i}
Opis (skrót z Wikipedii, może być niepełny): ${c}

Zadanie: Napisz dokładnie 3 zdania po polsku o najbliższej atrakcji dla audio przewodnika.
Zasady:
- Zaczynaj od krótkiego przedstawienia miejsca i jego znaczenia.
- Używaj naturalnego języka mówionego, unikaj nawiasów, skrótów i przypisów.
- Dodaj jedną ciekawostkę lub kontekst historyczny, jeśli to możliwe.
- Nie wspominaj o Wikipedii ani o źródłach.
- Maksymalnie ~60 słów łącznie.
`:`
Attraction: ${e.title}
Distance: ${i}
Summary (intro from Wikipedia, may be incomplete): ${c}

Task: Write exactly 3 sentences in English about the nearest attraction for an audio guide.
Guidelines:
- Start with a brief introduction of the place and why it matters.
- Use natural spoken language; avoid parentheses, abbreviations, and citations.
- Add one fun fact or historical context if possible.
- Do not mention Wikipedia or sources.
- About ~60 words total.
`,p={model:"gpt-4o-mini",temperature:.7,max_tokens:300,messages:[{role:"system",content:n},{role:"user",content:u}]},d=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$}`},body:JSON.stringify(p)});if(!d.ok){const g=await d.text().catch(()=>"");throw new Error(`OpenAI API błąd: HTTP ${d.status}. Odpowiedź: ${g.slice(0,500)}`)}const m=await d.json(),w=(h=(y=(r=m==null?void 0:m.choices)==null?void 0:r[0])==null?void 0:y.message)==null?void 0:h.content;if(!w)throw new Error("OpenAI nie zwrócił treści. Sprawdź limity i klucz API.");return w.replace(/\n+/g," ").trim()}async function W(e,a){l("Generowanie audio"),L();const t=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(S)}?optimize_streaming_latency=0&output_format=mp3_44100_128`,i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"audio/mpeg","xi-api-key":B},body:JSON.stringify({text:e,model_id:I,voice_settings:{stability:.5,similarity_boost:.5,style:.2,use_speaker_boost:!0}})});if(!i.ok){const u=await i.text().catch(()=>"");throw new Error(`ElevenLabs API błąd: HTTP ${i.status}. Odpowiedź: ${u.slice(0,500)}`)}const c=await i.arrayBuffer();return new Blob([c],{type:"audio/mpeg"})}async function K(e){if(l("Odtwarzanie"),o.src)try{URL.revokeObjectURL(o.src)}catch{}const a=URL.createObjectURL(e);o.src=a,o.load();try{await o.play()}catch(t){const n=t;throw new Error(`Nie udało się odtworzyć audio. iOS wymaga interakcji użytkownika. Spróbuj ponownie nacisnąć Start. Szczegóły: ${n.message}`)}await new Promise((t,n)=>{const i=()=>{o.removeEventListener("ended",c),o.removeEventListener("pause",u),o.removeEventListener("error",p),o.removeEventListener("abort",d);try{URL.revokeObjectURL(a)}catch{}},c=()=>{i(),t()},u=()=>{z||(i(),t())},p=()=>{var w;const m=((w=o.error)==null?void 0:w.message)||"nieznany błąd mediów";i(),n(new Error(`Błąd odtwarzania audio: ${m}`))},d=()=>{i(),n(new Error("Odtwarzanie przerwane."))};o.addEventListener("ended",c,{once:!0}),o.addEventListener("pause",u),o.addEventListener("error",p,{once:!0}),o.addEventListener("abort",d,{once:!0})})}async function V(){j(""),s("Start iteracji…");const e=N(),a=await U();s(`Lokalizacja: lat=${a.lat.toFixed(5)}, lon=${a.lon.toFixed(5)}`);const t=await R(a,e);s(`Najbliższa atrakcja: ${t.title} (${isFinite(t.distanceMeters)?Math.round(t.distanceMeters)+" m":"—"})`);const n=await M(t,e);s("Wygenerowano skrypt.");const i=await W(n);s("Audio gotowe. Odtwarzanie…"),await K(i),s("Odtwarzanie zakończone."),z&&(l("Oczekiwanie"),s("Czekam 10 sekund…"),await x(1e4))}async function C(){try{L()}catch(e){const a=e;l("Bezczynny"),j(""),s(a.message,!0);return}for(z=!0,f.disabled=!0,b.disabled=!1;z;)try{await V()}catch(e){const a=e;s(`Błąd w etapie „${O}”: ${a.message}`+(a.stack?`
Stack: ${a.stack}`:""),!0),l("Oczekiwanie"),s("Odczekuję 10 sekund i spróbuję ponownie…"),await x(1e4)}l("Bezczynny"),f.disabled=!1,b.disabled=!0,s("Zatrzymano pętlę.")}function H(){z=!1;try{o.pause()}catch{}}function Y(){o.muted=!0,o.play().catch(()=>{}).finally(()=>{o.pause(),o.muted=!1,o.removeAttribute("muted")})}f.addEventListener("click",async()=>{j("Uruchamianie…"),Y(),await C()});b.addEventListener("click",()=>{s("Żądanie zatrzymania…"),H()});(()=>{const e=!!$,a=!!B,t=[];t.push(`OpenAI klucz: ${e?"OK":"BRAK"}`),t.push(`ElevenLabs klucz: ${a?"OK":"BRAK"}`),s(t.join(" | "))})();
