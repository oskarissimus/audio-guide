(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const O=void 0,A=void 0,x="EXAVITQu4vr4xnSDxMaL",_="eleven_multilingual_v2",I=document.getElementById("stage"),p=document.getElementById("status"),g=document.getElementById("startBtn"),f=document.getElementById("stopBtn"),c=document.getElementById("player");let z=!1,L="Bezczynny";function u(t){L=t,I.textContent=t}function s(t,e=!1){const n=e?"❌ ":"• ";p.innerText=`${p.innerText}
${n}${t}`.trim(),e&&p.classList.add("error")}function k(t){p.classList.remove("error"),p.innerText=t}function B(t){return new Promise(e=>setTimeout(e,t))}function E(){const t=[];if(t.push("VITE_OPENAI_API_KEY"),t.push("VITE_ELEVENLABS_API_KEY"),t.length){const e=`Brak zmiennych środowiskowych: ${t.join(", ")}. Upewnij się, że sekrety repozytorium są ustawione i przekazywane do kompilacji.`;throw new Error(e)}}async function S(){return u("Pobieranie lokalizacji"),new Promise((t,e)=>{if(!("geolocation"in navigator)){e(new Error("Geolokalizacja nie jest obsługiwana przez tę przeglądarkę."));return}navigator.geolocation.getCurrentPosition(n=>{t({lat:n.coords.latitude,lon:n.coords.longitude})},n=>{const i=`code=${n.code}, message=${n.message}`;e(new Error(`Nie udało się pobrać lokalizacji. Szczegóły: ${i}`))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})})}async function T(t){var j,b,P;u("Wyszukiwanie atrakcji");const e=new URL("https://pl.wikipedia.org/w/api.php");e.searchParams.set("format","json"),e.searchParams.set("origin","*"),e.searchParams.set("action","query"),e.searchParams.set("list","geosearch"),e.searchParams.set("gscoord",`${t.lat}|${t.lon}`),e.searchParams.set("gsradius","1500"),e.searchParams.set("gslimit","10");const n=await fetch(e.toString(),{mode:"cors"});if(!n.ok)throw new Error(`Błąd zapytania geosearch Wikipedia: HTTP ${n.status}`);const i=await n.json(),a=(j=i==null?void 0:i.query)==null?void 0:j.geosearch;if(!a||a.length===0)throw new Error("Nie znaleziono żadnych atrakcji w pobliżu (Wikipedia geosearch).");const o=a[0],d=o.pageid,m=o.title,y=o.dist,r=new URL("https://pl.wikipedia.org/w/api.php");r.searchParams.set("format","json"),r.searchParams.set("origin","*"),r.searchParams.set("action","query"),r.searchParams.set("prop","extracts"),r.searchParams.set("exintro",""),r.searchParams.set("explaintext",""),r.searchParams.set("redirects","1"),r.searchParams.set("pageids",String(d));const l=await fetch(r.toString(),{mode:"cors"});if(!l.ok)throw new Error(`Błąd pobierania opisu z Wikipedii: HTTP ${l.status}`);const w=await l.json(),h=(P=(b=w==null?void 0:w.query)==null?void 0:b.pages)==null?void 0:P[d],$=(h==null?void 0:h.extract)??"";return{pageId:d,title:m,extract:$,distanceMeters:y??NaN}}async function v(t){var m,y,r;u("Generowanie skryptu"),E();const e="Jesteś lokalnym przewodnikiem turystycznym. Tworzysz zwięzłe, przyjazne i naturalne opisy atrakcji w języku polskim.",n=`
Atrakcja: ${t.title}
Odległość: ${isFinite(t.distanceMeters)?Math.round(t.distanceMeters)+" m":"nieznana"}
Opis (skrót z Wikipedii, może być niepełny): ${t.extract||"brak"}

Zadanie: Napisz dokładnie 3 zdania po polsku o najbliższej atrakcji dla audio przewodnika.
Zasady:
- Zaczynaj od krótkiego przedstawienia miejsca i jego znaczenia.
- Używaj naturalnego języka mówionego, unikaj nawiasów, skrótów i przypisów.
- Dodaj jedną ciekawostkę lub kontekst historyczny, jeśli to możliwe.
- Nie wspominaj o Wikipedii ani o źródłach.
- Maksymalnie ~60 słów łącznie.
`,i={model:"gpt-4o-mini",temperature:.7,max_tokens:300,messages:[{role:"system",content:e},{role:"user",content:n}]},a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify(i)});if(!a.ok){const l=await a.text().catch(()=>"");throw new Error(`OpenAI API błąd: HTTP ${a.status}. Odpowiedź: ${l.slice(0,500)}`)}const o=await a.json(),d=(r=(y=(m=o==null?void 0:o.choices)==null?void 0:m[0])==null?void 0:y.message)==null?void 0:r.content;if(!d)throw new Error("OpenAI nie zwrócił treści. Sprawdź limity i klucz API.");return d.replace(/\n+/g," ").trim()}async function N(t){u("Generowanie audio"),E();const e=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(x)}?optimize_streaming_latency=0&output_format=mp3_44100_128`,i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"audio/mpeg","xi-api-key":A},body:JSON.stringify({text:t,model_id:_,voice_settings:{stability:.5,similarity_boost:.5,style:.2,use_speaker_boost:!0}})});if(!i.ok){const o=await i.text().catch(()=>"");throw new Error(`ElevenLabs API błąd: HTTP ${i.status}. Odpowiedź: ${o.slice(0,500)}`)}const a=await i.arrayBuffer();return new Blob([a],{type:"audio/mpeg"})}async function U(t){if(u("Odtwarzanie"),c.src)try{URL.revokeObjectURL(c.src)}catch{}const e=URL.createObjectURL(t);c.src=e,c.load();try{await c.play()}catch(n){const i=n;throw new Error(`Nie udało się odtworzyć audio. iOS wymaga interakcji użytkownika. Spróbuj ponownie nacisnąć Start. Szczegóły: ${i.message}`)}}async function R(){k(""),s("Start iteracji…");const t=await S();s(`Lokalizacja: lat=${t.lat.toFixed(5)}, lon=${t.lon.toFixed(5)}`);const e=await T(t);s(`Najbliższa atrakcja: ${e.title} (${isFinite(e.distanceMeters)?Math.round(e.distanceMeters)+" m":"—"})`);const n=await v(e);s("Wygenerowano skrypt.");const i=await N(n);s("Audio gotowe. Odtwarzanie…"),await U(i),s("Odtwarzanie rozpoczęte."),u("Oczekiwanie"),s("Czekam 10 sekund…"),await B(1e4)}async function M(){try{E()}catch(t){const e=t;u("Bezczynny"),k(""),s(e.message,!0);return}for(z=!0,g.disabled=!0,f.disabled=!1;z;)try{await R()}catch(t){const e=t;s(`Błąd w etapie „${L}”: ${e.message}`+(e.stack?`
Stack: ${e.stack}`:""),!0),u("Oczekiwanie"),s("Odczekuję 10 sekund i spróbuję ponownie…"),await B(1e4)}u("Bezczynny"),g.disabled=!1,f.disabled=!0,s("Zatrzymano pętlę.")}function K(){z=!1;try{c.pause()}catch{}}function V(){c.muted=!0,c.play().catch(()=>{}).finally(()=>{c.pause(),c.muted=!1,c.removeAttribute("muted")})}g.addEventListener("click",async()=>{k("Uruchamianie…"),V(),await M()});f.addEventListener("click",()=>{s("Żądanie zatrzymania…"),K()});(()=>{const t=!!O,e=!!A,n=[];n.push(`OpenAI klucz: ${t?"OK":"BRAK"}`),n.push(`ElevenLabs klucz: ${e?"OK":"BRAK"}`),s(n.join(" | "))})();
