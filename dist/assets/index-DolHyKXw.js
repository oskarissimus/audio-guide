(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const P=void 0,O=void 0,$="EXAVITQu4vr4xnSDxMaL",x="eleven_multilingual_v2",_=document.getElementById("stage"),y=document.getElementById("status"),f=document.getElementById("startBtn"),z=document.getElementById("stopBtn"),i=document.getElementById("player");let w=!1,A="Bezczynny";function u(t){A=t,_.textContent=t}function d(t,e=!1){const n=e?"❌ ":"• ";y.innerText=`${y.innerText}
${n}${t}`.trim(),e&&y.classList.add("error")}function k(t){y.classList.remove("error"),y.innerText=t}function v(t){return new Promise(e=>setTimeout(e,t))}function E(){const t=[];if(t.push("VITE_OPENAI_API_KEY"),t.push("VITE_ELEVENLABS_API_KEY"),t.length){const e=`Brak zmiennych środowiskowych: ${t.join(", ")}. Upewnij się, że sekrety repozytorium są ustawione i przekazywane do kompilacji.`;throw new Error(e)}}async function I(){return u("Pobieranie lokalizacji"),new Promise((t,e)=>{if(!("geolocation"in navigator)){e(new Error("Geolokalizacja nie jest obsługiwana przez tę przeglądarkę."));return}navigator.geolocation.getCurrentPosition(n=>{t({lat:n.coords.latitude,lon:n.coords.longitude})},n=>{const r=`code=${n.code}, message=${n.message}`;e(new Error(`Nie udało się pobrać lokalizacji. Szczegóły: ${r}`))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})})}async function S(t){var b,j,L;u("Wyszukiwanie atrakcji");const e=new URL("https://pl.wikipedia.org/w/api.php");e.searchParams.set("format","json"),e.searchParams.set("origin","*"),e.searchParams.set("action","query"),e.searchParams.set("list","geosearch"),e.searchParams.set("gscoord",`${t.lat}|${t.lon}`),e.searchParams.set("gsradius","1500"),e.searchParams.set("gslimit","10");const n=await fetch(e.toString(),{mode:"cors"});if(!n.ok)throw new Error(`Błąd zapytania geosearch Wikipedia: HTTP ${n.status}`);const r=await n.json(),a=(b=r==null?void 0:r.query)==null?void 0:b.geosearch;if(!a||a.length===0)throw new Error("Nie znaleziono żadnych atrakcji w pobliżu (Wikipedia geosearch).");const o=a[0],c=o.pageid,p=o.title,m=o.dist,s=new URL("https://pl.wikipedia.org/w/api.php");s.searchParams.set("format","json"),s.searchParams.set("origin","*"),s.searchParams.set("action","query"),s.searchParams.set("prop","extracts"),s.searchParams.set("exintro",""),s.searchParams.set("explaintext",""),s.searchParams.set("redirects","1"),s.searchParams.set("pageids",String(c));const l=await fetch(s.toString(),{mode:"cors"});if(!l.ok)throw new Error(`Błąd pobierania opisu z Wikipedii: HTTP ${l.status}`);const h=await l.json(),g=(L=(j=h==null?void 0:h.query)==null?void 0:j.pages)==null?void 0:L[c],B=(g==null?void 0:g.extract)??"";return{pageId:c,title:p,extract:B,distanceMeters:m??NaN}}async function T(t){var p,m,s;u("Generowanie skryptu"),E();const e="Jesteś lokalnym przewodnikiem turystycznym. Tworzysz zwięzłe, przyjazne i naturalne opisy atrakcji w języku polskim.",n=`
Atrakcja: ${t.title}
Odległość: ${isFinite(t.distanceMeters)?Math.round(t.distanceMeters)+" m":"nieznana"}
Opis (skrót z Wikipedii, może być niepełny): ${t.extract||"brak"}

Zadanie: Napisz dokładnie 3 zdania po polsku o najbliższej atrakcji dla audio przewodnika.
Zasady:
- Zaczynaj od krótkiego przedstawienia miejsca i jego znaczenia.
- Używaj naturalnego języka mówionego, unikaj nawiasów, skrótów i przypisów.
- Dodaj jedną ciekawostkę lub kontekst historyczny, jeśli to możliwe.
- Nie wspominaj o Wikipedii ani o źródłach.
- Maksymalnie ~60 słów łącznie.
`,r={model:"gpt-4o-mini",temperature:.7,max_tokens:300,messages:[{role:"system",content:e},{role:"user",content:n}]},a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`},body:JSON.stringify(r)});if(!a.ok){const l=await a.text().catch(()=>"");throw new Error(`OpenAI API błąd: HTTP ${a.status}. Odpowiedź: ${l.slice(0,500)}`)}const o=await a.json(),c=(s=(m=(p=o==null?void 0:o.choices)==null?void 0:p[0])==null?void 0:m.message)==null?void 0:s.content;if(!c)throw new Error("OpenAI nie zwrócił treści. Sprawdź limity i klucz API.");return c.replace(/\n+/g," ").trim()}async function N(t){u("Generowanie audio"),E();const e=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent($)}?optimize_streaming_latency=0&output_format=mp3_44100_128`,r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"audio/mpeg","xi-api-key":O},body:JSON.stringify({text:t,model_id:x,voice_settings:{stability:.5,similarity_boost:.5,style:.2,use_speaker_boost:!0}})});if(!r.ok){const o=await r.text().catch(()=>"");throw new Error(`ElevenLabs API błąd: HTTP ${r.status}. Odpowiedź: ${o.slice(0,500)}`)}const a=await r.arrayBuffer();return new Blob([a],{type:"audio/mpeg"})}async function U(t){if(u("Odtwarzanie"),i.src)try{URL.revokeObjectURL(i.src)}catch{}const e=URL.createObjectURL(t);i.src=e,i.load();try{await i.play()}catch(n){const r=n;throw new Error(`Nie udało się odtworzyć audio. iOS wymaga interakcji użytkownika. Spróbuj ponownie nacisnąć Start. Szczegóły: ${r.message}`)}await new Promise((n,r)=>{const a=()=>{i.removeEventListener("ended",o),i.removeEventListener("pause",c),i.removeEventListener("error",p),i.removeEventListener("abort",m);try{URL.revokeObjectURL(e)}catch{}},o=()=>{a(),n()},c=()=>{w||(a(),n())},p=()=>{var l;const s=((l=i.error)==null?void 0:l.message)||"nieznany błąd mediów";a(),r(new Error(`Błąd odtwarzania audio: ${s}`))},m=()=>{a(),r(new Error("Odtwarzanie przerwane."))};i.addEventListener("ended",o,{once:!0}),i.addEventListener("pause",c),i.addEventListener("error",p,{once:!0}),i.addEventListener("abort",m,{once:!0})})}async function R(){k(""),d("Start iteracji…");const t=await I();d(`Lokalizacja: lat=${t.lat.toFixed(5)}, lon=${t.lon.toFixed(5)}`);const e=await S(t);d(`Najbliższa atrakcja: ${e.title} (${isFinite(e.distanceMeters)?Math.round(e.distanceMeters)+" m":"—"})`);const n=await T(e);d("Wygenerowano skrypt.");const r=await N(n);d("Audio gotowe. Odtwarzanie…"),await U(r),d("Odtwarzanie zakończone."),w&&(u("Oczekiwanie"),d("Czekam 10 sekund…"),await v(1e4))}async function M(){try{E()}catch(t){const e=t;u("Bezczynny"),k(""),d(e.message,!0);return}for(w=!0,f.disabled=!0,z.disabled=!1;w;)try{await R()}catch(t){const e=t;d(`Błąd w etapie „${A}”: ${e.message}`+(e.stack?`
Stack: ${e.stack}`:""),!0),u("Oczekiwanie"),d("Odczekuję 10 sekund i spróbuję ponownie…"),await v(1e4)}u("Bezczynny"),f.disabled=!1,z.disabled=!0,d("Zatrzymano pętlę.")}function K(){w=!1;try{i.pause()}catch{}}function V(){i.muted=!0,i.play().catch(()=>{}).finally(()=>{i.pause(),i.muted=!1,i.removeAttribute("muted")})}f.addEventListener("click",async()=>{k("Uruchamianie…"),V(),await M()});z.addEventListener("click",()=>{d("Żądanie zatrzymania…"),K()});(()=>{const t=!!P,e=!!O,n=[];n.push(`OpenAI klucz: ${t?"OK":"BRAK"}`),n.push(`ElevenLabs klucz: ${e?"OK":"BRAK"}`),d(n.join(" | "))})();
